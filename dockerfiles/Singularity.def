Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export CONDA_DIR=/opt/conda
    export PATH=$CONDA_DIR/bin:$PATH
    export PATH=$CONDA_DIR/envs/pyside62/bin:$PATH
    export CONDA_DEFAULT_ENV=pyside62
    export AIPS_DISK=/etc/aips.dadevs

%post
    apt-get update && apt-get install -y \
        tcsh python3 python3-pip git curl build-essential gfortran \
        libx11-dev xterm libreadline-dev libncurses-dev wget \
        libglib2.0-0 unzip rsync sudo \
        libxcb1 libxcb-xinerama0 libxcb-icccm4 libxcb-image0 \
        libxcb-keysyms1 libxcb-render0 libxcb-shape0 libxcb-shm0 \
        libxcb-sync1 libxcb-xfixes0 libxkbcommon-x11-0 libx11-xcb1 \
        libxcb-glx0 libxcb-render-util0 libegl1 libdbus-1-3 \
        libgl1-mesa-glx libgl1-mesa-dri mesa-utils libxrender1 \
        libxkbcommon-x11-0 x11-xserver-utils libxcomposite1 \
        libxcursor1 libxi6 libxtst6 libxrandr2 libnss3 libasound2 && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

    useradd -m -d /usr/local/aips -s /bin/bash aips && \
        passwd -d aips && \
        usermod -aG sudo aips

    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
        bash miniconda.sh -b -p /opt/conda && \
        rm miniconda.sh

    chown -R aips:aips /opt/conda
    
    cp /opt/pyside62.yml /usr/local/aips/
    chown aips:aips /usr/local/aips/pyside62.yml

    su - aips -c "source /opt/conda/etc/profile.d/conda.sh && conda init bash && conda env create -f /usr/local/aips/pyside62.yml && echo 'conda activate pyside62' >> ~/.bashrc"
    
    # Create AIPS DISK

    mkdir -p /usr/local/aips/DISKS/DISK_1
    touch /usr/local/aips/DISKS/DISK_1/SPACE
    echo "+  /usr/local/aips/DISKS/DISK_1" > /etc/aips.dadevs
    chmod 644 /etc/aips.dadevs

    cd /usr/local/aips
    cp /opt/.AIPSRC .AIPSRC
    wget ftp://ftp.aoc.nrao.edu/pub/software/aips/31DEC24/install.pl && \
        chmod 755 install.pl && \
        su - aips -c "perl install.pl -n"

    printf '\nsssin           5000/tcp        SSSIN      # AIPS TV server\nssslock         5002/tcp        SSSLOCK    # AIPS TV Lock\nmsgserv         5008/tcp        MSGSERV    # AIPS Message Server\ntekserv         5009/tcp        TEKSERV    # AIPS TekServer\naipsmt0         5010/tcp        AIPSMT0    # AIPS remote FITS disk access\naipsmt1         5011/tcp        AIPSMT1    # AIPS remote tape 1\naipsmt2         5012/tcp        AIPSMT2    # AIPS remote tape 2\n' >> /etc/services

    printf '\n# all users should source AIPS\nif [ -f /usr/local/aips/LOGIN.SH ]; then\n  source /usr/local/aips/LOGIN.SH\nfi\n' >> /etc/bash.bashrc

    mkdir -p /usr/local/aips/aips/vipcals
    cp -r /opt/vipcals /usr/local/aips/aips/
    chown -R aips:aips /usr/local/aips/aips/vipcals

    # Make AIPS and vipcals group/world-readable so container user can access
    chmod -R a+rx /usr/local/aips

%files
    pyside62.yml /opt/pyside62.yml
    31DEC24 /opt/.AIPSRC
    ../../vipcals /opt/vipcals

%runscript
    source /opt/conda/etc/profile.d/conda.sh
    conda activate pyside62
    source /usr/local/aips/LOGIN.SH
    cd /usr/local/aips/aips/vipcals/GUI
    exec python3 run_GUI_docker.py

